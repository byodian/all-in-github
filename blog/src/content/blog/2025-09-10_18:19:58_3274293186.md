---
tags:
  - rclone
  - cloudflare
categories:
  - Snippets
  - Note
title: 备份 Postgres 数据，自动上传至 Cloudflare R2 对象存储
slug: "3274293186"
author: byodian
pubDatetime: 2025-09-10T10:19:58Z
modDatetime: 2025-09-11T08:28:47Z
description: ""
---



## 安装 Rclone

Rclone 是一个命令行程序，同步你的文件到云存储。 

在 Linux/BSD/macOS 系统安装，运行命令：
```bash
sudo -v ; curl https://rclone.org/install.sh | sudo bash
```
在 Windowes 系统安装，[下载](https://rclone.org/downloads/)程序压缩包，解压并运行 `rclone.exe`。

## 配置 Rclone

终端运行：
```bash
rclone config
```

选择 Cloudflare R2 为远端存储：
```bash
n) New remote
name> r2
Storage> s3
provider> Cloudflare
env_auth> false
access_key_id> <YOUR_ACCESS_KEY>
secret_access_key> <YOUR_SECRET_KEY>
region> auto
endpoint> https://<ACCOUNT_ID>.r2.cloudflarestorage.com
Edit advanced config? > n
Keep this "r2" remote? > y
```

生成的配置文件存储在 `~/.config/rclone/rclone.conf`，文件内容如下，更多细节参考 [rclone config docs](https://rclone.org/docs/)。

```text file=~/.config/rclone/rclone.conf
[r2]
type = s3
provider = Cloudflare
access_key_id = abc123
secret_access_key = xyz456
endpoint = https://<accountid>.r2.cloudflarestorage.com
```

> [!WARNING]
> 如果你的 Cloudflare 对象存储 token 使用 [Object-level permissions](https://developers.cloudflare.com/r2/api/tokens/#permissions)，你需要在 rclone 配置中增加 `no_check_bucket = true`。

```text file=~/.config/rclone/rclone.conf
[r2]
type = s3
provider = Cloudflare
access_key_id = abc123
secret_access_key = xyz456
endpoint = https://<accountid>.r2.cloudflarestorage.com
// [!code ++]
no_check_bucket = true
```

## Rclone 命令
### List buckets & objects
```bash file=backup_pg_rclone.sh
rclone tree r2:
rclone tree r2:database
```
### Upload and retrieve objects
```bash
# Upload dog.txt to the database bucket
rclone copy dog.txt r2:database/
rclone tree r2:database

# Download dog.txt from the database bucket
rclone copy r2:database/dot.txt .
```

更多命令细节参考 [Rclone Commands](https://rclone.org/commands/)。

## Postgress 数据库备份命令

备份整个数据库集群内容

```bash
pg_dumpall > dumpfile
```

恢复备份数据（从 pg_dumpall 生成的文件）

```bash
psql -X -f dumpfile dbname
# 或者
psql -X dbname < dumpfile
```

压缩备份数据

```bash
pg_dumpall | gzip > filename.gz
```

恢复压缩数据（从 pg_dumpall 生成的文件）

```bash
gunzip -c filename.gz | psql -X dbname
# 或者
cat filename.gz | gunzip | psql -X dbname 
```

恢复 `psql` 无法加载的自定义文件格式备份数据

```bash
pg_restore -d dbname filename
```

查看 [pg_dump](https://www.postgresql.org/docs/current/app-pgdump.html) 、 [pg_restore](https://www.postgresql.org/docs/current/app-pgrestore.html)、[pg_dumpall](https://www.postgresql.org/docs/current/app-pg-dumpall.html) 和 [psql](https://www.postgresql.org/docs/current/app-psql.html) 引用获取更多细节。

## Postgres 数据自动备份和上传 Cloudflare R2 脚本
```bash
#!/bin/bash

# ------------------------
# 配置部分
# ------------------------
RCLONE_REMOTE="r2:database"   # rclone 远程 bucket
PG_CONTAINER="wcskkokws4co0o8800s0wcs0" # Docker 容器名
PG_USER_NAME="postgres"
BACKUP_DIR="/data/backups/postgres"
DATE=$(date +"%Y%m%d_%H%M%S")

# ------------------------
# 创建备份目录
# ------------------------
mkdir -p "$BACKUP_DIR"

# ------------------------
# 导出 PostgreSQL 数据库
# ------------------------
BACKUP_FILE="pg_dumpall_$DATE.sql"
BACKUP_PATH="$BACKUP_DIR/$BACKUP_FILE"

echo "[$(date)] 开始备份 PostgreSQL..."
docker exec -i "$PG_CONTAINER" pg_dumpall -U "$PG_USER_NAME" > "$BACKUP_PATH"

if [ $? -ne 0 ]; then
    echo "[$(date)] PostgreSQL 导出失败"
    exit 1
fi

# ------------------------
# 压缩备份文件
# ------------------------
GZ_FILE="$BACKUP_PATH.gz"
gzip -c "$BACKUP_PATH" > "$GZ_FILE"
rm -f "$BACKUP_PATH"

# ------------------------
# 上传到 Cloudflare R2
# ------------------------
echo "[$(date)] 上传到 R2..."
rclone copy "$GZ_FILE" "$RCLONE_REMOTE" --progress --retries 3 --low-level-retries 5

if [ $? -ne 0 ]; then
    echo "[$(date)] 上传失败"
    exit 1
fi

echo "[$(date)] 上传成功: $RCLONE_REMOTE/$DATE.sql.gz"
```

给脚本添加可执行权限

```bash
chmod +x backup_pg_rclone.sh
```

## 设置 Cron 定时任务
终端运行 `crontab -e`，编辑任务
```
0 1 * * * /path/to/backup_pg_rclone.sh >> /var/log/pg_backup_rclone.log 2>&1
```

## 参考
- [Cloudflare Rclone 文档](https://developers.cloudflare.com/r2/examples/rclone/)
- [Rclone 官方文档](https://rclone.org/)
- [PostgresSQL Dump](https://www.postgresql.org/docs/current/backup-dump.html)
- [Cron 表达式生成器](https://crontab.cronhub.io/)
- [PostgreSQL Client Applications](https://www.postgresql.org/docs/current/reference-client.html)