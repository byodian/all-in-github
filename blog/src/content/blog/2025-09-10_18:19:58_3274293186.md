---
tags:
  - rclone
  - cloudflare
categories:
  - Snippets
  - Note
title: 备份 Postgres 数据，自动上传 Cloudflare R2 对象存储
slug: "3274293186"
author: byodian
pubDatetime: 2025-09-10T10:19:58Z
modDatetime: 2025-09-10T10:19:58Z
description: ""
---



```bash
#!/bin/bash

# ------------------------
# 配置部分
# ------------------------
RCLONE_REMOTE="r2:database"   # rclone 远程 bucket
PG_CONTAINER="wcskkokws4co0o8800s0wcs0" # Docker 容器名
BACKUP_DIR="/data/backups/postgres"
DATE=$(date +"%Y%m%d_%H%M%S")

# ------------------------
# 创建备份目录
# ------------------------
mkdir -p "$BACKUP_DIR"

# ------------------------
# 导出 PostgreSQL 数据库
# ------------------------
BACKUP_FILE="pg_dumpall_$DATE.sql"
BACKUP_PATH="$BACKUP_DIR/$BACKUP_FILE"

echo "[$(date)] 开始备份 PostgreSQL..."
docker exec -i "$PG_CONTAINER" pg_dumpall -U postgres > "$BACKUP_PATH"

if [ $? -ne 0 ]; then
    echo "[$(date)] PostgreSQL 导出失败"
    exit 1
fi

# ------------------------
# 压缩备份文件
# ------------------------
GZ_FILE="$BACKUP_PATH.gz"
gzip -c "$BACKUP_PATH" > "$GZ_FILE"
rm -f "$BACKUP_PATH"

# ------------------------
# 上传到 Cloudflare R2
# ------------------------
echo "[$(date)] 上传到 R2..."
rclone copy "$GZ_FILE" "$RCLONE_REMOTE" --progress --retries 3 --low-level-retries 5

if [ $? -ne 0 ]; then
    echo "[$(date)] 上传失败"
    exit 1
fi

echo "[$(date)] 上传成功: $RCLONE_REMOTE/$DATE.sql.gz"
```